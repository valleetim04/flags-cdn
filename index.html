<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flag Guess — 8 Hints</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-start:#0a0f1f; --bg-end:#0f172a;
      --card:#0d1224; --card-2:#0b1220;
      --text:#e5e7eb; --muted:#93a3b8;
      --accent:#24d4ee; --accent-2:#38bdf8;
      --ok:#34d399; --warn:#f59e0b; --err:#f87171;
      --border:#1f2937; --shadow: rgba(0,0,0,.45);
      --hint-ring:#21324a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(1200px 700px at 10% -10%, rgba(56,189,248,.15), transparent 40%),
                  radial-gradient(1000px 600px at 110% 10%, rgba(36,212,238,.12), transparent 40%),
                  linear-gradient(180deg, var(--bg-start), var(--bg-end));
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:grid; place-items:center; padding:24px;
    }
    .app{
      width:min(960px,100%);
      background:
        radial-gradient(1200px 900px at -20% 120%, rgba(56,189,248,.06), transparent 40%),
        var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      padding:26px;
      box-shadow:0 18px 50px var(--shadow);
      position:relative; overflow:hidden;
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background: radial-gradient(100% 100% at 20% 20%, var(--accent-2), #58ecff);
      box-shadow:0 0 0 4px rgba(56,189,248,.15), 0 8px 22px rgba(56,189,248,.25);
      display:grid; place-items:center; color:#00121a; font-weight:900; font-family:Poppins, Inter, sans-serif;
      letter-spacing:0.5px;
    }
    h1{font-family:Poppins, Inter, sans-serif; font-size:clamp(20px,3.5vw,28px); margin:0}
    .sub{color:var(--muted); margin:2px 0 14px}

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;
      background:linear-gradient(180deg, #0b1220, #0b1323);
      border:1px solid var(--border); border-radius:14px; padding:12px;
    }
    select, input[type="text"], button{
      border-radius:12px; border:1px solid var(--border); background:#0a1322; color:var(--text);
      padding:12px 14px; font-size:15px; outline:none; transition:.18s;
    }
    input:focus, select:focus{border-color:#31527a; box-shadow:0 0 0 3px rgba(56,189,248,.18)}
    button{cursor:pointer; font-weight:600}
    .btn-primary{background:linear-gradient(180deg, var(--accent-2), #0ea5e9); border:none; color:#031018}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-ghost{background:transparent; color:var(--muted)}
    .btn-ghost:hover{color:var(--accent); border-color:#2a3c56}

    .layout{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; margin-top:14px}
    @media (max-width: 860px){ .layout{grid-template-columns:1fr} }

    .hints{
      background:var(--card-2); border:1px solid var(--border); border-radius:16px; padding:14px;
    }
    .hint{
      position:relative;
      background:linear-gradient(180deg, #0a1425, #0d172b);
      border:1px solid var(--hint-ring);
      border-radius:12px; padding:12px 14px; margin:10px 0;
      box-shadow: inset 0 0 18px rgba(36,212,238,.06);
      animation: cardIn .35s ease;
    }
    .hint::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius:12px;
      padding:1px;
      background: radial-gradient(120px 40px at 12% 0%, rgba(56,189,248,.25), transparent 40%),
                  linear-gradient(90deg, rgba(56,189,248,.35), rgba(36,212,238,.0));
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); 
      -webkit-mask-composite: xor; mask-composite: exclude;
      pointer-events:none;
    }
    .hint-title{font-weight:700; color:#bcd3ff; font-size:14px; margin-bottom:6px}
    .hint-text{color:#cfd8e3; line-height:1.35}

    .meta{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; margin-top:12px;
    }
    .kpi{
      background:#0b1323; border:1px solid var(--border); border-radius:12px; padding:12px; text-align:center;
    }
    .kpi p{margin:0; font-size:12px; color:var(--muted)}
    .kpi h3{margin:4px 0 0; font-size:20px; color:var(--accent-2); font-weight:700}

    .flagbox{
      background:var(--card-2); border:1px solid var(--border); border-radius:16px; padding:14px;
    }
    .flag{
      width:100%; max-width:360px; border-radius:12px; border:1px solid #21324a; display:block; margin:10px auto 0;
      transform: translateZ(0);
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .flag.revealed{ box-shadow:0 12px 40px rgba(56,189,248,.25); transform:scale(1.02); }

    .status { margin-top:12px; font-size:14px; color:var(--muted); min-height:22px }
    .status.ok{ color:var(--ok) } .status.warn{ color:var(--warn) } .status.err{ color:var(--err) }

    .progress{
      display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap;
    }
    .dot{
      width:18px; height:18px; border-radius:999px; border:1px solid #2a3c56; background:#0b1323;
      box-shadow: inset 0 0 8px rgba(56,189,248,.08);
      position:relative; overflow:hidden;
    }
    .dot.active::after{
      content:""; position:absolute; inset:0;
      background:radial-gradient(20px 20px at 40% 30%, rgba(56,189,248,.6), transparent 40%);
      animation: glow .9s ease both;
    }
    @keyframes glow{ from{opacity:0} to{opacity:1} }
    @keyframes cardIn{ from{transform:translateY(6px); opacity:0} to{transform:none; opacity:1} }
    @keyframes wobble{20%{transform:translateX(-3px)} 40%{transform:translateX(3px)} 60%{transform:translateX(-2px)} 80%{transform:translateX(2px)}}

    /* custom dropdown (limited to 5) */
    .dropdown{
      position:relative; min-width:260px;
    }
    .dropdown input{
      width:100%;
    }
    .suggest{
      position:absolute; z-index:50; top:100%; left:0; right:0; margin-top:6px;
      background:#071226; border:1px solid #1f2a3b; border-radius:12px; overflow:hidden;
      display:none; max-height:240px; box-shadow:0 14px 28px rgba(0,0,0,.45);
    }
    .suggest.show{ display:block; }
    .opt{
      padding:10px 12px; font-size:14px; cursor:pointer; border-bottom:1px solid #0f1a2b;
    }
    .opt:last-child{ border-bottom:none }
    .opt:hover{ background:#0e1b32; color:var(--accent-2); }
    .badge{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px;
      background:rgba(56,189,248,.10); border:1px solid rgba(56,189,248,.28); color:#c7e9ff; font-weight:600;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="brand">
        <div class="logo">FG</div>
        <div>
          <h1>Flag Guess — 8 Hints</h1>
          <div class="sub">Guess the country from flag-composition hints. Fewer hints = more points.</div>
        </div>
      </div>
      <div class="badge" title="Two modes available">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l3.09 6.26L22 9.27l-5 4.88L18.18 22 12 18.54 5.82 22 7 14.15l-5-4.88 6.91-1.01L12 2z"/></svg>
        Daily challenge ready
      </div>
    </div>

    <div class="controls">
      <div>
        <label class="sr" for="mode">Mode</label>
        <select id="mode" aria-label="Game mode">
          <option value="ONU">Normal — UN Member States</option>
          <option value="TOUS">Hard — All Flags</option>
        </select>
      </div>

      <div class="dropdown" id="dropdown">
        <label class="sr" for="guess">Guess the country</label>
        <input id="guess" type="text" inputmode="search" spellcheck="false" placeholder="Type a country name" autocomplete="off" />
        <div class="suggest" id="suggest"></div>
      </div>

      <button id="btnGuess" class="btn-primary">Guess</button>
      <button id="btnSkip" class="btn-ghost">Next Hint</button>
      <button id="btnNew"  class="btn-ghost">New Round</button>
    </div>

    <div class="layout">
      <section>
        <div class="hints" id="hints"></div>
        <div class="progress" id="progress"></div>
        <div class="meta">
          <div class="kpi"><p>Current hint</p><h3 id="kpiHint">—</h3></div>
          <div class="kpi"><p>Round points</p><h3 id="kpiPoints">—</h3></div>
          <div class="kpi"><p>Total score</p><h3 id="kpiTotal">0</h3></div>
        </div>
        <div class="status" id="status" role="status" aria-live="polite"></div>
      </section>

      <aside class="flagbox">
        <div style="font-size:12px; color:var(--muted)">Flag (revealed on correct answer)</div>
        <img id="flag" class="flag" src="" alt="Flag preview" style="display:none" />
      </aside>
    </div>
  </div>

  <script>
    // ---- FIXED CONFIG (edit in code only) ----
    const SHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbzGIDarUwZ_6PF9liyTT9i1VCku4iCb1yySnbi0hPq6QOg1jBCQfM0iAtcAFi3GRqzi/exec";
    const FLAGS_BASE_PATH = "https://valleetim04.github.io/flags-cdn/flags/"; // ex: ./flags/aa.svg

    // ---- STATE ----
    let DB = [];        // [{code, name, onu, hints[8]}]
    let POOL = [];      // filtered by mode
    let current = null; // current country object
    let hintIndex = 0;  // 0..7
    let totalScore = 0;

    // ---- HELPERS ----
    const $ = (sel) => document.querySelector(sel);
    const norm = (s) => (s || "").normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase().trim();

    function setStatus(msg, kind="info"){
      const el = $("#status");
      el.textContent = msg || "";
      el.className = "status " + (kind==="success"?"ok":kind==="warn"?"warn":kind==="error"?"err":"");
    }

    function renderProgress(){
      const p = $("#progress");
      p.innerHTML = "";
      for (let i=0;i<8;i++){
        const d = document.createElement("div");
        d.className = "dot" + (i<=hintIndex ? " active": "");
        p.appendChild(d);
      }
    }

    function renderHints(){
      const box = $("#hints");
      box.innerHTML = "";
      if (!current) return;
      const max = Math.min(hintIndex+1, current.hints.length);
      for (let i=0;i<max;i++){
        const card = document.createElement("div");
        card.className = "hint";
        card.innerHTML = `<div class="hint-title">Hint ${i+1}</div><div class="hint-text">${current.hints[i] || ""}</div>`;
        box.appendChild(card);
      }
      $("#kpiHint").textContent = hintIndex+1;
      $("#kpiPoints").textContent = Math.max(0, 8 - hintIndex);
      renderProgress();
    }

    function revealFlag(){
      const img = $("#flag");
      img.src = FLAGS_BASE_PATH + String(current.code).toLowerCase() + ".svg";
      img.style.display = "block";
      img.classList.add("revealed");
    }

    function applyMode(){
      const mode = $("#mode").value;
      POOL = DB.filter(o => mode === "TOUS" ? true : (String(o.onu).toUpperCase() === "Y"));
    }

    function pickRandom(){
      if (!POOL.length){ setStatus("No countries available for this mode.", "error"); return; }
      current = POOL[Math.floor(Math.random() * POOL.length)];
      hintIndex = 0;
      $("#flag").style.display = "none";
      $("#flag").classList.remove("revealed");
      $("#guess").value = "";
      renderHints();
      setStatus("New round started! Good luck.");
      updateSuggestions(""); // reset dropdown
    }

    // ---- STRICT INPUT LIMITATION + TOP-5 SUGGESTIONS ----
    const drop = $("#dropdown");
    const input = $("#guess");
    const suggest = $("#suggest");

    function top5Matches(q){
      const qn = norm(q);
      if (!qn) return [];
      // prioritize startsWith, then includes
      const starts = DB.filter(o => norm(o.name).startsWith(qn));
      const inc = DB.filter(o => !norm(o.name).startsWith(qn) && norm(o.name).includes(qn));
      return [...starts, ...inc].slice(0,5).map(o => o.name);
    }

    function updateSuggestions(q){
      const items = top5Matches(q);
      suggest.innerHTML = "";
      if (!items.length){ suggest.classList.remove("show"); return; }
      for (const name of items){
        const div = document.createElement("div");
        div.className = "opt";
        div.textContent = name;
        div.addEventListener("click", () => {
          input.value = name;
          suggest.classList.remove("show");
          input.focus();
        });
        suggest.appendChild(div);
      }
      suggest.classList.add("show");
    }

    input.addEventListener("input", (e) => {
      const val = e.target.value;
      if (!val){ suggest.classList.remove("show"); return; }
      updateSuggestions(val);
    });

    input.addEventListener("focus", () => {
      if (input.value) updateSuggestions(input.value);
    });

    document.addEventListener("click", (e) => {
      if (!drop.contains(e.target)) suggest.classList.remove("show");
    });

    // ---- GUESS LOGIC ----
    function tryGuess(){
      if (!current) return;
      const val = input.value;
      const v = norm(val);

      // Strict: MUST be one of the names in DB (column B)
      const match = DB.find(o => norm(o.name) === v);
      if (!match){
        // shake input & message
        setStatus("Please pick a country from the list (Column B).", "error");
        input.classList.add("shake");
        input.value = ""; // auto-clear for next attempt
        setTimeout(() => input.classList.remove("shake"), 500);
        return;
      }

      // Clear on attempt (as requested on failure; on success, we keep just for a moment)
      const isCorrect = (match.name === current.name);
      if (isCorrect){
        revealFlag();
        const gained = Math.max(0, 8 - hintIndex);
        totalScore += gained;
        $("#kpiTotal").textContent = totalScore;
        setStatus(`Correct! It was ${current.name}. +${gained} pts`, "success");
        suggest.classList.remove("show");
      } else {
        if (hintIndex < 7){
          hintIndex++;
          renderHints();
          setStatus("Wrong. Another hint has been revealed.", "warn");
        } else {
          revealFlag();
          setStatus(`Out of hints! It was ${current.name}.`, "error");
        }
        input.value = ""; // auto-clear on failed guess
        updateSuggestions(""); // close suggestions
        // subtle wobble on wrong
        $("#hints").style.animation = "wobble .35s ease";
        setTimeout(() => $("#hints").style.animation = "", 360);
      }
    }

    function nextHint(){
      if (!current) return;
      if (hintIndex < 7){
        hintIndex++;
        renderHints();
        setStatus("Another hint revealed.");
      } else {
        setStatus("All hints are already revealed.", "warn");
      }
    }

    // ---- LOAD DATA ----
    async function loadDB(){
      try{
        const res = await fetch(SHEET_JSON_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP "+res.status);
        const raw = await res.json();
        DB = (raw || []).map(o => ({
          code: String(o.code || "").trim(),
          name: String(o.name || "").trim(),
          onu:  String(o.onu  || "").trim().toUpperCase(),
          hints: Array.isArray(o.hints) ? o.hints.slice(0,8).map(x => String(x||"")) : []
        })).filter(x => x.code && x.name && x.hints.length);
        applyMode();
        pickRandom();
      } catch(err){
        console.error(err);
        setStatus("Failed to load data. Check Web App URL & permissions.", "error");
      }
    }

    // ---- EVENTS ----
    $("#btnGuess").addEventListener("click", tryGuess);
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") tryGuess(); });
    $("#btnSkip").addEventListener("click", nextHint);
    $("#btnNew").addEventListener("click", pickRandom);
    $("#mode").addEventListener("change", () => { applyMode(); pickRandom(); });

    // small helper effect
    const style = document.createElement("style");
    style.textContent = `.shake{animation:wobble .35s ease}`;
    document.head.appendChild(style);

    // boot
    loadDB();
  </script>
</body>
</html>
